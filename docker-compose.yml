# ============================================================================
# Ash v5.0 Docker Compose Configuration
# ============================================================================
# FILE VERSION: v5.0
# LAST MODIFIED: 2026-01-02
# Repository: https://github.com/the-alphabet-cartel/ash
# Community: The Alphabet Cartel - https://discord.gg/alphabetcartel
# ============================================================================
#
# USAGE:
#   # Start services
#   docker-compose up -d
#
#   # View logs
#   docker-compose logs -f ash
#
#   # Stop services
#   docker-compose down
#
#   # Rebuild and start
#   docker-compose up -d --build
#
# SECRETS:
#   Secrets are stored in ./secrets/ directory:
#   - ./secrets/huggingface - HuggingFace API token
#   - ./secrets/discord_alert_webhook - Discord webhook for alerts (optional)
#
# REQUIREMENTS:
#   - Docker Engine 24.0+
#   - Docker Compose v2.20+
#   - NVIDIA Container Toolkit (for GPU support)
#
# ============================================================================
### Common Variables ###
x-common: &common
  networks:
    - ash-network
  restart: unless-stopped

### Common Environmental Variables ###
x-env: &env
  PGID: 1001
  PUID: 1001
  TZ: America/Los_Angeles

### Healthchecks ###
x-health: &health
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 120s
  start_interval: 30s

services:
  # ===========================================================================
  # Ash-NLP Service
  # ===========================================================================
  ash-nlp:
    image: ghcr.io/the-alphabet-cartel/ash-nlp:latest
    container_name: ash-nlp
    #build:
    #  context: ./ash-nlp/
    #  dockerfile: Dockerfile
    #  target: runtime
    <<: *common

    # GPU Support (requires NVIDIA Container Toolkit)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    # Environment variables
    environment:
      <<: *env
    env_file:
      - .env

    # Volume mounts
    volumes:
      # Model cache (persistent) - models download at startup, not build time
      # First startup: 5-15 min (downloads ~3GB of models)
      # Subsequent: ~30 sec (uses cached models)
      - ./ash-nlp/models-cache:/app/models-cache
      # Logs
      - ./ash-nlp/logs:/app/logs

    # Port mapping
    ports:
      - "30880:30880"

    # Docker Secrets
    secrets:
      - discord_alert_token
      - huggingface_token

    # Health check
    healthcheck:
      <<: *health
      test: ["CMD", "curl", "-f", "http://localhost:30880/health"]

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Labels for organization
    labels:
      - "org.alphabetcartel.service=ash-nlp"
      - "org.alphabetcartel.version=5.0.0"
      - "org.alphabetcartel.description=Crisis Detection Backend"

  # ===========================================================================
  # Ash-Bot Service
  # ===========================================================================
  ash-bot:
    image: ghcr.io/the-alphabet-cartel/ash-bot:latest
    container_name: ash-bot
    #build:
    #  context: ./ash-bot/
    #  dockerfile: Dockerfile
    <<: *common

    # Resource limits (production)
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

    # Environment variables
    environment:
      <<: *env
    env_file:
      - .env

    # Volume Mounts
    volumes:
      # Logs
      - ./ash-bot/logs:/app/logs
      # Testing (Development only)
      - /storage/nas/git/ash/ash-bot/tests:/app/tests

    # Port mapping for health checks (Ash ecosystem: 30881)
    ports:
      - "30881:30881"

    # Docker Secrets
    secrets:
      - claude_api_token
      - discord_alert_token
      - discord_bot_token
      - redis_token

    # Health check - uses HTTP endpoint from health server
    healthcheck:
      <<: *health
      test: ["CMD", "curl", "-f", "http://localhost:30881/health"]

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Labels for organization
    labels:
      - "org.alphabetcartel.service=ash-bot"
      - "org.alphabetcartel.version=5.0.0"
      - "org.alphabetcartel.description=Crisis Detection Discord Bot"

    # Dependencies
    depends_on:
      ash-nlp:
        condition: service_healthy
      ash-redis:
        condition: service_healthy

  # ===========================================================================
  # Ash-Dash Service
  # ===========================================================================
  #  ash-dash:
  #    image: ghcr.io/the-alphabet-cartel/ash-dash:latest
  #    container_name: ash-dash
  #    #build:
  #    #  context: .
  #    #  dockerfile: Dockerfile
  #    <<: *common
  #
  #    # Resource limits (production)
  #    deploy:
  #      resources:
  #        limits:
  #          memory: 512M
  #          cpus: "0.5"
  #
  #    # Environment variables
  #    environment:
  #      <<: *env
  #    env_file:
  #      - .env
  #
  #    # Volume Mounts
  #    volumes:
  #      # Logs
  #      - ./logs:/app/logs
  #      # Testing (Development only)
  #      - ./ash-dash/tests:/app/tests
  #
  #    # Port mapping for health checks (Ash ecosystem: 30882)
  #    ports:
  #      - "30882:30882"
  #
  #    # Docker Secrets
  #    secrets:
  #      - discord_alert_token
  #      #- redis_token
  #
  #    # Health check - uses HTTP endpoint from health server
  #    healthcheck:
  #      <<: *health
  #      test: ["CMD", "curl", "-f", "http://localhost:30882/health"]
  #
  #    # Logging configuration
  #    logging:
  #      driver: "json-file"
  #      options:
  #        max-size: "50m"
  #        max-file: "5"
  #
  #    # Labels for organization
  #    labels:
  #      - "org.alphabetcartel.service=ash-dash"
  #      - "org.alphabetcartel.version=5.0.0"
  #      - "org.alphabetcartel.description=Ash Crisis Detection Dashboard"
  #
  #    # Depends On
  #    depends_on:
  #      ash-nlp:
  #        condition: service_healthy
  #      ash-bot:
  #        condition: service_healthy
  #      ash-redis:
  #        condition: service_healthy
  #
  # ===========================================================================
  # Ash-Thrash Service
  # ===========================================================================
  #  ash-thrash:
  #    image: ghcr.io/the-alphabet-cartel/ash-thrash:latest
  #    container_name: ash-thrash
  #    #build:
  #    #  context: .
  #    #  dockerfile: Dockerfile
  #    <<: *common
  #
  #    # Resource limits (production)
  #    deploy:
  #      resources:
  #        limits:
  #          memory: 512M
  #          cpus: "0.5"
  #
  #    # Environment variables
  #    environment:
  #      <<: *env
  #    env_file:
  #      - .env
  #
  #    # Volume Mounts
  #    volumes:
  #      # Logs
  #      - ./logs:/app/logs
  #      # Testing (Development only)
  #      - ./ash-thrash/tests:/app/tests
  #
  #    # Port mapping for health checks (Ash ecosystem: 30883)
  #    ports:
  #      - "30883:30883"
  #
  #    # Docker Secrets
  #    secrets:
  #      - discord_alert_token
  #      #- redis_token
  #
  #    # Health check - uses HTTP endpoint from health server
  #    healthcheck:
  #      <<: *health
  #      test: ["CMD", "curl", "-f", "http://localhost:30883/health"]
  #
  #    # Logging configuration
  #    logging:
  #      driver: "json-file"
  #      options:
  #        max-size: "50m"
  #        max-file: "5"
  #
  #    # Labels for organization
  #    labels:
  #      - "org.alphabetcartel.service=ash-thrash"
  #      - "org.alphabetcartel.version=5.0.0"
  #      - "org.alphabetcartel.description=Ash Crisis Detection Performance Testing"
  #
  #    # Depends On
  #    depends_on:
  #      ash-nlp:
  #        condition: service_healthy
  #      ash-bot:
  #        condition: service_healthy
  #      ash-dash:
  #        condition: service_healthy
  #      ash-redis:
  #        condition: service_healthy
  #
  # ===========================================================================
  # Ash-Redis Cache
  # ===========================================================================
  ash-redis:
    image: redis:7-alpine
    container_name: ash-redis
    <<: *common

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.25"

    # Volume mounts
    volumes:
      - redis_data:/data

    # Docker Secrets - mount redis password
    secrets:
      - redis_token

    # Redis configuration with password from secret
    command: sh -c 'redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --requirepass "$(cat /run/secrets/redis_token)"'

    # Health check (with auth)
    healthcheck:
      <<: *health
      test:
        [
          "CMD",
          "sh",
          "-c",
          'redis-cli -a "$(cat /run/secrets/redis_token)" ping 2>/dev/null | grep -q PONG',
        ]

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

    # Labels
    labels:
      - "org.alphabetcartel.service=ash-redis"
      - "org.alphabetcartel.description=Redis cache for Ash-Bot"

# =============================================================================
# Secrets
# =============================================================================
secrets:
  claude_api_token:
    file: ./secrets/claude_api_token
  discord_alert_token:
    file: ./secrets/discord_alert_token
  discord_bot_token:
    file: ./secrets/discord_bot_token
  huggingface_token:
    file: ./secrets/huggingface_token
  redis_token:
    file: ./secrets/redis_token
  webhook_token:
    file: ./secrets/webhook_token

# =============================================================================
# Volumes
# =============================================================================
volumes:
  # Redis Data Persistence
  redis_data:
    name: redis_data
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  ash-network:
    name: ash-network
    driver: bridge
    external: true
